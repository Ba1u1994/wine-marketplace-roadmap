name: weekly devlog stub

on:
  schedule:
    - cron: "0 7 * * MON"   # Every Monday 07:00 UTC (11:00 Tbilisi)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  make-entry:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute filename
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          export TZ=Asia/Tbilisi

          Y=$(date +%Y)
          M=$(date +%m)

          mkdir -p changelog

          max=0
          shopt -s nullglob
          for f in changelog/${Y}-${M}-week-*.md; do
            n=$(basename "$f" | sed -E 's/.*week-([0-9]{2})\.md/\1/')
            if [[ "$n" =~ ^[0-9]+$ ]] && [ "$n" -gt "$max" ]; then
              max=$n
            fi
          done
          NEXT=$(printf "%02d" $((max + 1)))

          echo "filename=changelog/${Y}-${M}-week-${NEXT}.md" >> "$GITHUB_OUTPUT"
          echo "y=$Y" >> "$GITHUB_OUTPUT"
          echo "m=$M" >> "$GITHUB_OUTPUT"
          echo "w=$NEXT" >> "$GITHUB_OUTPUT"

      - name: Build markdown content from commits
        id: build
        uses: actions/github-script@v7
        env:
          YEAR: ${{ steps.meta.outputs.y }}
          MONTH: ${{ steps.meta.outputs.m }}
          WEEK: ${{ steps.meta.outputs.w }}
        with:
          github-token: ${{ secrets.DEVLOG_TOKEN }}
          script: |
            const owner = 'Ba1u1994';
            const repos = ['wine-marketplace', 'wine-marketplace-roadmap'];

            // áƒ‘áƒáƒšáƒ 7 áƒ“áƒ¦áƒ˜áƒ¡ commit-áƒ”áƒ‘áƒ˜
            const since = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();

            const buckets = {
              feat: [],
              fix: [],
              docs: [],
              chore: [],
              refactor: [],
              ci: [],
              test: [],
              other: []
            };

            const inProgress = [];  // commit-áƒ”áƒ‘áƒ˜, áƒ¡áƒáƒ“áƒáƒª áƒ©áƒáƒœáƒ¡ "wip", "draft", "in progress"
            const keywords = {
              feat: /^feat/i,
              fix: /^fix/i,
              docs: /^docs?/i,
              chore: /^chore/i,
              refactor: /^refactor/i,
              ci: /^ci/i,
              test: /^tests?/i
            };

            for (const repo of repos) {
              const commits = await github.paginate(
                github.rest.repos.listCommits,
                { owner, repo, since }
              );

              for (const c of commits) {
                const msgFull = c.commit.message || '';
                const msg = msgFull.split('\n')[0]; // áƒžáƒ˜áƒ áƒ•áƒ”áƒšáƒ˜ áƒ®áƒáƒ–áƒ˜
                const line = `- **${repo}**: ${msg}`;

                let cat = 'other';
                for (const [key, regex] of Object.entries(keywords)) {
                  if (regex.test(msg)) {
                    cat = key;
                    break;
                  }
                }
                buckets[cat].push(line);

                const lower = msgFull.toLowerCase();
                if (lower.includes('wip') ||
                    lower.includes('in progress') ||
                    lower.includes('draft')) {
                  inProgress.push(line);
                }
              }
            }

            const nonEmpty = (arr) => arr && arr.length > 0;

            // áƒ¨áƒ”áƒáƒ’áƒ áƒáƒ•áƒ”áƒ— "What I accomplished" áƒ¢áƒ”áƒ¥áƒ¡áƒ¢áƒ˜ áƒ™áƒáƒ¢áƒ”áƒ’áƒáƒ áƒ˜áƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒ˜áƒ®áƒ”áƒ“áƒ•áƒ˜áƒ—
            let accomplished = '';
            const sections = [
              ['feat',     '### Features'],
              ['fix',      '### Fixes'],
              ['docs',     '### Docs'],
              ['chore',    '### Chores / Cleanup'],
              ['refactor', '### Refactors'],
              ['ci',       '### CI / Automation'],
              ['test',     '### Tests'],
              ['other',    '### Other Work']
            ];

            for (const [key, title] of sections) {
              const items = buckets[key];
              if (nonEmpty(items)) {
                accomplished += `${title}\n`;
                accomplished += items.join('\n') + '\n\n';
              }
            }

            if (!accomplished) {
              accomplished = '- (no commits found in the last 7 days)';
            }

            // "In progress" â€“ WIP commit-áƒ”áƒ‘áƒ˜ áƒ—áƒ£ áƒáƒ áƒ¡áƒ”áƒ‘áƒáƒ‘áƒ¡
            let inProgText = '';
            if (nonEmpty(inProgress)) {
              inProgText = inProgress.join('\n');
            } else {
              inProgText = '- (update ongoing work here)';
            }

            // "What I learned" â€“ áƒ›áƒáƒ¦áƒáƒšáƒ˜ áƒ“áƒáƒœáƒ˜áƒ¡ áƒ¨áƒáƒ‘áƒšáƒáƒœáƒ˜ áƒ™áƒáƒ¢áƒ”áƒ’áƒáƒ áƒ˜áƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒ˜áƒ®áƒ”áƒ“áƒ•áƒ˜áƒ—
            const learned = [];
            if (nonEmpty(buckets.feat)) {
              learned.push('- Built or extended new features (feature work).');
            }
            if (nonEmpty(buckets.fix)) {
              learned.push('- Improved stability by fixing bugs.');
            }
            if (nonEmpty(buckets.docs) || nonEmpty(buckets.chore)) {
              learned.push('- Invested time in documentation and codebase cleanup.');
            }
            if (nonEmpty(buckets.ci)) {
              learned.push('- Learned more about CI/CD and automation workflows.');
            }
            if (nonEmpty(buckets.refactor)) {
              learned.push('- Practiced refactoring and improving existing design.');
            }
            if (learned.length === 0) {
              learned.push('- (reflect on key learnings from this week)');
            }

            const year = process.env.YEAR;
            const month = process.env.MONTH;
            const week = process.env.WEEK;
            const today = new Date().toISOString().slice(0, 10);

            const markdown = [
              `# Week ${week} â€“ ${year}-${month}`,
              '',
              `_Date created:_ ${today}`,
              '',
              '## âœ… What I accomplished',
              accomplished.trimEnd(),
              '',
              '## ðŸ”§ In progress',
              inProgText,
              '',
              '## ðŸ§  What I learned',
              learned.join('\n')
            ].join('\n');

            core.setOutput('content', markdown);

      - name: Write file
        shell: bash
        run: |
          set -euo pipefail
          file="${{ steps.meta.outputs.filename }}"
          if [ -f "$file" ]; then
            echo "File exists: $file (skipping write)"
            exit 0
          fi

          printf '%s\n' "${{ steps.build.outputs.content }}" > "$file"

      - name: Commit and push
        shell: bash
        run: |
          git config user.name "ba1u-bot"
          git config user.email "actions@users.noreply.github.com"
          git add "${{ steps.meta.outputs.filename }}"
          git commit -m "chore(devlog): create ${{ steps.meta.outputs.filename }}" || exit 0
          git push
