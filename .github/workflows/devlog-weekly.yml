name: weekly devlog stub

on:
  schedule:
    # Every Monday 07:00 UTC == 11:00 Asia/Tbilisi
    - cron: "0 7 * * MON"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  make-entry:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute next filename
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          export TZ=Asia/Tbilisi
          Y=$(date +%Y)
          M=$(date +%m)
          mkdir -p changelog

          # áƒ›áƒáƒ«áƒ”áƒ‘áƒœáƒ” áƒ£áƒ™áƒ•áƒ” áƒáƒ áƒ¡áƒ”áƒ‘áƒ£áƒšáƒ˜ week áƒ¤áƒáƒ˜áƒšáƒ”áƒ‘áƒ˜ áƒ“áƒ áƒ’áƒáƒ›áƒáƒ—áƒ•áƒáƒšáƒ” áƒ¨áƒ”áƒ›áƒ“áƒ”áƒ’áƒ˜
          max=0
          shopt -s nullglob
          for f in changelog/${Y}-${M}-week-*.md; do
            n=$(echo "$f" | sed -E 's/.*week-([0-9]{2})\.md/\1/')
            if [[ "$n" =~ ^[0-9]+$ ]] && [ "$n" -gt "$max" ]; then max=$n; fi
          done
          NEXT=$(printf "%02d" $((max + 1)))

          FILENAME="changelog/${Y}-${M}-week-${NEXT}.md"
          {
            echo "filename=$FILENAME"
            echo "y=$Y"
            echo "m=$M"
            echo "w=$NEXT"
          } >> "$GITHUB_OUTPUT"

      - name: Create entry file
        shell: bash
        run: |
          set -euo pipefail
          file="${{ steps.meta.outputs.filename }}"
          if [ -f "$file" ]; then
            echo "File already exists: $file (skipping)"
            exit 0
          fi

          today=$(date +%Y-%m-%d)
          cat > "$file" <<'EOF'
# Week PLACEHOLDER â€“ YYYY-MM

_Date created:_ DATE_PLACEHOLDER

## âœ… What I accomplished
- ...

## ðŸ”§ In progress
- ...

## ðŸ§  What I learned
- ...
EOF

          # Placeholder replacements
          sed -i "s/PLACEHOLDER/${{ steps.meta.outputs.w }}/" "$file"
          sed -i "s/YYYY/${{ steps.meta.outputs.y }}/" "$file"
          sed -i "s/MM/${{ steps.meta.outputs.m }}/" "$file"
          sed -i "s/DATE_PLACEHOLDER/${today}/" "$file"

      - name: Commit and push
        shell: bash
        run: |
          git config user.name "ba1u-bot"
          git config user.email "actions@users.noreply.github.com"
          git add "${{ steps.meta.outputs.filename }}"
          git commit -m "chore(devlog): create ${{ steps.meta.outputs.filename }}" || exit 0
          git push
