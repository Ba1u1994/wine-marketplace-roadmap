name: weekly devlog stub

on:
  schedule:
    - cron: "0 7 * * MON"   # Every Monday 07:00 UTC (11:00 Tbilisi)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  make-entry:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute next filename
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          export TZ=Asia/Tbilisi
          Y=$(date +%Y)
          M=$(date +%m)
          mkdir -p changelog

          # Find largest existing week number for this month
          max=0
          shopt -s nullglob
          for f in changelog/${Y}-${M}-week-*.md; do
            n=$(basename "$f" | sed -E 's/.*week-([0-9]{2})\.md/\1/')
            [[ "$n" =~ ^[0-9]+$ ]] && (( n > max )) && max=$n
          done
          NEXT=$(printf "%02d" $((max + 1)))

          echo "filename=changelog/${Y}-${M}-week-${NEXT}.md" >> "$GITHUB_OUTPUT"
          echo "y=$Y" >> "$GITHUB_OUTPUT"
          echo "m=$M" >> "$GITHUB_OUTPUT"
          echo "w=$NEXT" >> "$GITHUB_OUTPUT"

      - name: Create entry file
        shell: bash
        run: |
          set -euo pipefail
          file="${{ steps.meta.outputs.filename }}"
          [[ -f "$file" ]] && echo "File exists: $file (skipping)" && exit 0

          today=$(date +%Y-%m-%d)
          printf "# Week %s â€“ %s-%s\n\n" "${{ steps.meta.outputs.w }}" "${{ steps.meta.outputs.y }}" "${{ steps.meta.outputs.m }}" > "$file"
          printf "_Date created:_ %s\n\n" "$today" >> "$file"
          printf "## âœ… What I accomplished\n- ...\n\n" >> "$file"
          printf "## ðŸ”§ In progress\n- ...\n\n" >> "$file"
          printf "## ðŸ§  What I learned\n- ...\n" >> "$file"

      - name: Commit and push
        shell: bash
        run: |
          git config user.name "ba1u-bot"
          git config user.email "actions@users.noreply.github.com"
          git add "${{ steps.meta.outputs.filename }}"
          git commit -m "chore(devlog): create ${{ steps.meta.outputs.filename }}" || exit 0
          git push
